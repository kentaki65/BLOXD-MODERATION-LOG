//MIT License
//Copyright (c) 2026 kentaki65
//This project includes modified code from "bim"
//Licensed under AGPL-3.0
//Original source: rentry.co/2kcfyvmv

const config = {
  SERVER_LOGS_PER_MESSAGE: 5,
  BLOCK_LOGS_PER_MESSAGE: 3,
  PREVENT_CHANGE_BY_EXPLOSIVE: true,
  SAVE_CHANGE_BY_WORLD: false,
  SAVE_DATA_CHANGED_BY_WORLD: true,
  SAVE_DATA_CHANGED_BY_PLAYER: true,
  MAX_BLOCK_HISTORY: 5,
  LOG_SHOW_NEWEST_FIRST: true,
  BLOCKLOG_SHOW_NEWEST_FIRST: true,
  INSPECT_SHOW_NEWEST_FIRST: true,
  ENABLE_LOGGING: true,
  SEARCH_TIMEOUT: 1000,
  ALLOW_LIST: ["5hFYzhrL29VWQHxYvaAHe"],
  BLACK_LIST: []
};
S={t:{},g:{},c:0,o:0,i:0,d:{get false(){let e=S.t[S.c];do{let t=3*S.i;[e[t],e=>e][+(e[t+2]<S.g[e[t+1]])]()}while(++S.i<e.length/3);delete S.t[S.c],S.i=0}},run(e,t,n){let l=S.c-~t-1,o=S.t[l]=[S.t[l],[]][+!S.t[l]],s=o.length;o[s]=e,o[s+1]=[n,"0"][+!n],o[s+2]=S.o++},stop(e){S.g[e]=S.o++}};const BASE=[-35e4,-35e4,-35e4],BASE2=[35e4,-35e4,35e4],MAX_X=7e5,MAX_Y=3e5,MAX_Z=7e5,ITEM="Stick",SLOTS=36,MAX_DESC=1976,MAX_RAM_CACHE_SIZE=2e3,MAX_CHEST_CACHE_SIZE=200,MAX_CHARS_PER_TICK=33.333333333333336;class LRUCache{constructor(e){this.maxSize=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}set(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxSize){let n=this.cache.keys().next().value;this.cache.delete(n)}this.cache.set(e,t)}}function safeMod(e,t){let n=0;for(let l=0;l<e.length;l++)n=(10*n+(e.charCodeAt(l)-48))%t;return n}function safeDivide(e,t){let n="",l=0;for(let o=0;o<e.length;o++){let s=10*l+(e.charCodeAt(o)-48);n+=s/t|0,l=s%t}return n.replace(/^0+/,"")}function makeStore(e){let t=new LRUCache(2e3),n=new LRUCache(200),l=(e,t,l,o,s,i)=>{api.setStandardChestItemSlot(e,t,l,o,s,i);let a=e+"",c=n.get(a);c||(c=api.getStandardChestItemSlots(e)),c[t]={name:l,amount:o,attributes:i},n.set(a,c)},o=(e,t)=>{let l=e+"",o=n.get(l);return o||(o=api.getStandardChestItems(e),n.set(l,o)),o[t]};return{RAMtasksQueue:{start:0,end:0},RAMcache:t,chestCache:n,setSlot:l,getSlot:o,decodeIndex(t){let n=String(t),l=safeMod(n,SLOTS);n=safeDivide(n,SLOTS);let o=safeMod(n,MAX_X);n=safeDivide(n,MAX_X);let s=safeMod(n,MAX_Y);n=safeDivide(n,MAX_Y);let i=safeMod(n,7e5);return{slot:l,pos:[e[0]+o,e[1]+s,e[2]+i]}}}}const S1=makeStore(BASE),S2=makeStore(BASE2);bim1={get(e,t){S1.RAMtasksQueue[S1.RAMtasksQueue.end++]=[0,e+"",t]},set(e,t,n){S1.RAMtasksQueue[S1.RAMtasksQueue.end++]=[1,e+"",n,t]}},bim2={get(e,t){S2.RAMtasksQueue[S2.RAMtasksQueue.end++]=[0,e+"",t]},set(e,t,n){S2.RAMtasksQueue[S2.RAMtasksQueue.end++]=[1,e+"",n,t]}};let RAMwait=0;tick=()=>{if(S.d[!S.t[S.c]],S.c++,RAMwait>33.333333333333336){RAMwait-=33.333333333333336;return}RAMwait=0;let e=3*api.getNumPlayers();function t(t){let n=t.RAMtasksQueue;main:for(let l=0;l<e;l++){if(n.start===n.end){n.start=n.end=0;break}let o=n[n.start],s=o[0],i=o[1],a=o[2],c=(o[3]??"")+"",r=t.decodeIndex(i),u=r.pos,h=r.slot;if(!api.isBlockInLoadedChunk(...u)){api.getBlock(u);break}if(s){let $=c.slice(0,1976);"Loot Chest"!==api.getBlock(u)&&(api.setBlock(u,"Loot Chest"),RAMwait+=210),t.setSlot(u,h,ITEM,1,void 0,{customDescription:$}),t.RAMcache.set(i,{val:$,max:$.length}),a&&a(i,$)}else{let g="",d=t.RAMcache.get(i);if(d)g=d.val;else if("Loot Chest"===api.getBlock(u)){let f=t.getSlot(u,h);f?.name===ITEM&&(g=f.attributes?.customDescription||"")}t.RAMcache.set(i,{val:g,max:g.length}),a&&a(i,g)}if(delete n[n.start++],RAMwait>33.333333333333336)break main}}t(S1),t(S2)};class log{constructor(){this.Queue=[],this.count=1,this.saving=!1,this.META_COUNT_KEY=0,this.maxLen=12,this.blockQueue=[],this.blockSaving=!1,this.blockCount=1,this.blockWriteKey=1,this.BLOCK_META_COUNT_KEY=0,this.blockMaxLen=10,this.BLOCK_ACTION={place:1,break:2,replace:3,worldChange:4};let e=this;this.ready=!1,this.bim1Get(this.META_COUNT_KEY,function(t){let n=Number(t);e.count=Number.isFinite(n)&&n>0?n:1,e.writeKey=e.count,e._timer=S.run(function t(){e.flushTemporary(),S.run(t,100,"timer")},1),e.ready=!0}),this.bim2Get(this.BLOCK_META_COUNT_KEY,t=>{let n=Number(t);this.blockCount=Number.isFinite(n)&&n>0?n:1,this.blockWriteKey=this.blockCount,e._blockTimer=S.run(function t(){e.flushBlockTemporary(),S.run(t,500,"blocktimer")},1)})}convertToDate(e){let t=Math.floor(e/1e3)+32400,n=Math.floor(t/86400),l=t%86400,o=1970,s=e=>e%4==0&&(e%100!=0||e%400==0);for(;;){let i=s(o)?366:365;if(n<i)break;n-=i,o++}let a=[31,s(o)?29:28,31,30,31,30,31,31,30,31,30,31],c=0;for(;n>=a[c];)n-=a[c],c++;return{year:o,month:c+1,date:n+1,hour:Math.floor(l/3600),minutes:Math.floor(l%3600/60),second:l%60}}zigzag=e=>e>=0?2*e:-(2*e)-1;unzigzag=e=>1&e?-(e+1)/2:e/2;encInt=e=>{let t=this.zigzag(e),n="";for(;t>=8192;)n+=String.fromCharCode(8191&t|8192),t=Math.floor(t/8192);return n+String.fromCharCode(t)};decInt=(e,t)=>{let n=0,l=0,o;do n+=(8191&(o=e.charCodeAt(t++)))*Math.pow(8192,l++);while(8192&o);return[this.unzigzag(n),t]};bim1Get(e,t){bim1.get(e,(e,n)=>t(n))}bim1Set(e,t,n){bim1.set(e,t,()=>n&&n())}addQueue(e){this.Queue.push(e),this.Queue.length>=this.maxLen&&this.flushTemporary()}addQueueImmediate(e){this.Queue.push(e),this.saving||this.flushTemporary()}_takeQueue(){let e=this.Queue;return this.Queue=[],e}flushTemporary(){if(this.saving||0===this.Queue.length)return;this.saving=!0;let e=this._takeQueue(),t=this.writeKey,n=this;this.bim1Get(t,function(l){let o;try{o=l?JSON.parse(l):[],Array.isArray(o)||(o=[])}catch{o=[]}let s=n.maxLen-o.length;s>0&&(o.push.apply(o,e.slice(0,s)),n.bim1Set(t,JSON.stringify(o)));let i=e.slice(s);i.length>0?n.bim1Set(n.META_COUNT_KEY,String(t+1),function(){n.count=t+1,n.writeKey=n.count,n.Queue.unshift.apply(n.Queue,i),n.saving=!1,n.Queue.length>0&&n.flushTemporary()}):(n.saving=!1,n.Queue.length>0&&n.flushTemporary())})}formatLog(e){let[t,n,l,o,s]=e.split("|"),i=this.convertToDate(Number(t)),a=e=>String(e).padStart(2,"0"),c=`${i.year}/${a(i.month)}/${a(i.date)} ${a(i.hour)}:${a(i.minutes)}:${a(i.second)}`;return[c,n,l,o,s||""]}bim2Get(e,t){bim2.get(e,(e,n)=>t(n))}bim2Set(e,t,n){bim2.set(e,t,()=>n&&n())}addBlockQueue(e){this.blockQueue.push(e),this.blockQueue.length>=this.blockMaxLen&&this.flushBlockTemporary()}addBlockQueueImmediate(e){this.blockQueue.push(e),this.blockSaving||this.flushBlockTemporary()}_takeBlockQueue(){let e=this.blockQueue;return this.blockQueue=[],e}flushBlockTemporary(){if(this.blockSaving||0===this.blockQueue.length)return;this.blockSaving=!0;let e=this._takeBlockQueue(),t=this.blockWriteKey,n=!1,l=()=>{!n&&(n=!0,this.blockSaving=!1,this.blockQueue.length>0&&this.flushBlockTemporary())};this.bim2Get(t,n=>{let o;try{o=n?JSON.parse(n):[],Array.isArray(o)||(o=[])}catch{o=[]}let s=this.blockMaxLen-o.length,i=s>0?e.slice(0,s):[],a=e.slice(i.length);i.length>0&&o.push(...i),this.bim2Set(t,JSON.stringify(o),()=>{let e=o.length>=this.blockMaxLen;if(a.length>0||e){let n=t+1;this.bim2Set(this.BLOCK_META_COUNT_KEY,String(n),()=>{this.blockCount=n,this.blockWriteKey=n,a.length>0&&this.blockQueue.unshift(...a),l()})}else l()})}),S.run(()=>{this.blockSaving&&(api.log("[log] blockSaving timeout -> force release"),l())},100,"blockFailSafe")}encodeBlockLog({epoch:e,x:t,y:n,z:l,action:o,block:s,dbId:i,name:a}){let c=e=>this.encInt(e.length)+e;return this.encInt(e)+this.encInt(t)+this.encInt(n)+this.encInt(l)+this.encInt(this.BLOCK_ACTION[o]||0)+c(i)+c(a)+c(s||"")}decodeBlockLog(e){let t=0,n;[n,t]=this.decInt(e,t);let l=n;[n,t]=this.decInt(e,t);let o=n;[n,t]=this.decInt(e,t);let s=n;[n,t]=this.decInt(e,t);let i=n;[n,t]=this.decInt(e,t);let a=n;[n,t]=this.decInt(e,t);let c=e.slice(t,t+n);t+=n,[n,t]=this.decInt(e,t);let r=e.slice(t,t+n);t+=n,[n,t]=this.decInt(e,t);let u=e.slice(t,t+n);return t+=n,{epoch:l,x:o,y:s,z:i,action:a,dbId:c,name:r,block:u}}}const logInstance=new log,inspector=new Set,BanQueue=new Set;function makeLogStr(e,t,n=""){let l=api.now(),o;return`${l}|${t}|${api.getEntityName(e)}|${api.getPlayerDbId(e)}|${n}`}function onReady(e){logInstance.ready?e():S.run(()=>onReady(e),200)}S.run(function e(){[...BanQueue].forEach(e=>{api.getPlayerIds().includes(e)&&api.kickPlayer(e,"Banned from lobby")}),S.run(e,20)}),onPlayerJoin=e=>{let t=makeLogStr(e,"join"),n=api.getPlayerDbId(e);config.BLACK_LIST.includes(n)&&BanQueue.add(e),onReady(()=>{config.ENABLE_LOGGING&&logInstance.addQueueImmediate(t)})},onPlayerLeave=e=>{BanQueue.has(e)&&BanQueue.delete(e)},onPlayerChat=(e,t)=>{let n=makeLogStr(e,"chat",t);onReady(()=>{config.ENABLE_LOGGING&&logInstance.addQueue(n)})},onPlayerChangeBlock=(e,t,n,l,o,s)=>{if(!logInstance.ready)return;if(inspector.has(e)){let i=api.getBlockData(t,n,l),a=i?.persisted??{},c=Array.isArray(a.log)?a.log.slice():[];if(0===c.length)return api.sendMessage(e,[{str:"このブロックには履歴がありません\n",style:{color:"#999999"}}]),"preventChange";let r=e=>String(e).padStart(2,"0"),u=config.INSPECT_SHOW_NEWEST_FIRST?c.slice().reverse():c,h=u.flatMap(({epoch:e,action:t,from:n,to:l,dbId:o,name:s})=>{let i=logInstance.convertToDate(e),a="Air"===l?n:l,c=`${i.year}/${r(i.month)}/${r(i.date)} ${r(i.hour)}:${r(i.minutes)}:${r(i.second)}`;return[{str:`[${c}] `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:`${s} `,style:{color:"#0090a8",fontStyle:"italic"}},{str:`${t} `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:`${a}`,style:{color:"#0090a8",fontStyle:"italic"}},{str:` (${o})
`,style:{color:"#D3D3D3",fontStyle:"italic"}}]});return api.sendMessage(e,h),"preventChange"}let $,g;"Air"===o&&"Air"!==s?($="place",g=s):"Air"!==o&&"Air"===s?($="break",g=o):($="replace",g=s);let d=api.getPlayerDbId(e),f=api.getEntityName(e)||"unknown",y=logInstance.encodeBlockLog({epoch:api.now(),x:0|t,y:0|n,z:0|l,action:$,block:g,dbId:d,name:f});if(logInstance.addBlockQueue(y),config.SAVE_DATA_CHANGED_BY_PLAYER){let k=api.getBlockData(t,n,l),A=k?.persisted??{},m=Array.isArray(A.log)?A.log.slice():[];m.push({epoch:api.now(),action:$,from:o,to:s,dbId:d,name:f}),m.length>config.MAX_BLOCK_HISTORY&&(m=m.slice(-1*config.MAX_BLOCK_HISTORY)),api.setBlockData(t,n,l,{persisted:{log:m}})}},onWorldChangeBlock=(e,t,n,l,o,s,i)=>{let a=api.getEntityName(api.getPlayerIdFromDbId(s));if(config.SAVE_CHANGE_BY_WORLD){let c=logInstance.encodeBlockLog({epoch:api.now(),x:0|e,y:0|t,z:0|n,action:"worldChange",block:`${l||"unknown"}->${o||"unknown"}`,dbId:s||"unknown",name:a||"unknown"});logInstance.addBlockQueue(c)}if(config.SAVE_CHANGE_BY_WORLD){let r=api.getBlockData(e,t,n),u=r?.persisted??{},h=Array.isArray(u.log)?u.log.slice():[];h.push({epoch:api.now(),action:"worldChange",from:l,to:o,dbId:s,name:a||"unknown"}),h.length>5&&(h=h.slice(h.length-5)),api.setBlockData(e,t,n,{persisted:{log:h}})}if(i?.cause==="Explosion"&&config.PREVENT_CHANGE_BY_EXPLOSIVE)return"preventChange"},playerCommand=(e,t)=>{let n=t.split(" "),l=n[0],o=api.getPlayerDbId(e),s=config.ALLOW_LIST.includes(o);if(!s){api.sendMessage(e,"許可リストに含まれていないためコマンドは使用できません");return}if("bml"===l&&("inspect"===n[1]||"i"===n[1])&&s)return inspector.has(e)?(inspector.delete(e),api.sendMessage(e,"BloxdModeratorLog: inspecter now disable!")):(inspector.add(e),api.sendMessage(e,"BloxdModeratorLog: inspecter now enable!")),!0;let i=({totalCount:t,getChunk:l,formatEntry:o,filters:s,render:i})=>{let a=n[2],c="*"===a?0:parseInt(a),r=s.limit,u=c*r,h="*"===a,$=[],g=Date.now(),d=s.newestFirst?t:1,f=s.newestFirst?-1:1;function y(){if(s.newestFirst&&d<1||!s.newestFirst&&d>t||Date.now()-g>config.SEARCH_TIMEOUT){i(e,$,c,r,h);return}l(d,t=>{let n=[];try{n=JSON.parse(t),Array.isArray(n)||(n=[])}catch{}let l=s.newestFirst?n.slice().reverse():n;for(let a of l){let g=o(a);s.match(g)&&$.length>=u&&$.length<u+r&&$.push(g)}d+=f,$.length<u+r?y():i(e,$,c,r,h)})}y()};if("bml"===l&&"log"===n[1]&&s)return i({totalCount:logInstance.count,getChunk:logInstance.bim1Get.bind(logInstance),formatEntry:logInstance.formatLog.bind(logInstance),filters:{newestFirst:config.LOG_SHOW_NEWEST_FIRST,limit:config.SERVER_LOGS_PER_MESSAGE,match(e){let[t,l,o,s,i]=e;return(!n[3]||"*"===n[3]||o===n[3]||s===n[3])&&(!n[4]||"*"===n[4]||l===n[4])&&(!n[5]||"*"===n[5]||i&&i.includes(n[5]))}},render(e,t,n,l,o){let s=[{str:`=== Bloxd Moderation Log ${o?"(first "+l+")":`(page ${n})`} ===
`,style:{color:"#aaa",fontStyle:"italic"}}],i=e=>"join"===e?"#5AFF19":"leave"===e?"#B1221A":"#FFC800";for(let[a,c,r,u,h]of t)h?s.push({str:`[${a}] `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:`[${c}] `,style:{color:i(c),fontStyle:"italic"}},{str:r+" ",style:{color:"#0090a8",fontStyle:"italic"}},{str:h,style:{fontStyle:"italic"}},{str:` (${u})
`,style:{color:"#D3D3D3",fontStyle:"italic"}}):s.push({str:`[${a}] `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:r+" ",style:{color:"#0090a8",fontStyle:"italic"}},{str:`${c}ed`,style:{color:i(c),fontStyle:"italic"}},{str:` (${u})
`,style:{color:"#D3D3D3",fontStyle:"italic"}});s.length>0&&api.sendMessage(e,s)}}),!0;if("bml"===l&&"block"===n[1]&&s){let a=e=>e&&"*"!==e?["+","place","set"].includes(e=e.toLowerCase())?"+":["-","break","remove"].includes(e)?"-":["⟳","update","change"].includes(e)?"⟳":["✧","custom"].includes(e)?"✧":e:"*",c=n[3],r=a(n[4]),u=t.match(/"([^"]+)"/)?.[1]||n[6];return i({totalCount:logInstance.blockCount,getChunk:logInstance.bim2Get.bind(logInstance),formatEntry(e){let t=logInstance.decodeBlockLog(e),n=logInstance.convertToDate(t.epoch),l=e=>String(e).padStart(2,"0");return{time:`${n.year}/${l(n.month)}/${l(n.date)} ${l(n.hour)}:${l(n.minutes)}:${l(n.second)}`,name:t.name,dbId:t.dbId,x:t.x,y:t.y,z:t.z,action:["+","-","⟳","✧"][t.action-1]||"unknown",block:t.block||""}},filters:{newestFirst:config.BLOCKLOG_SHOW_NEWEST_FIRST,limit:config.BLOCK_LOGS_PER_MESSAGE,match:e=>(!c||"*"===c||e.name===c||e.dbId===c)&&(!r||"*"===r||e.action===r)&&(!u||"*"===u||e.block.includes(u))},render(e,t,n,l,o){let s=[{str:`=== Block Log ${o?"(first "+l+")":`(page ${n})`} ===
`,style:{color:"#aaaaaa",fontStyle:"italic"}}],i=e=>"+"===e?"#5AFF19":"-"===e?"#B1221A":"✧"===e?"#007DC5":"#FFC800";for(let a of t)s.push({str:`[${a.time}] `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:a.name+" ",style:{color:"#0090a8",fontStyle:"italic"}},{str:a.action+" ",style:{color:i(a.action),fontStyle:"italic",fontSize:"20px"}},{str:a.block+" ",style:{color:"#FFC800",fontStyle:"italic"}},{str:`at (${a.x},${a.y},${a.z})`,style:{fontStyle:"italic"}},{str:` (${a.dbId})
`,style:{color:"#D3D3D3",fontStyle:"italic"}});s.length>0&&api.sendMessage(e,s)}}),!0}};
