//This project includes modified code from "bim"
//Licensed under AGPL-3.0
//Original source: rentry.co/2kcfyvmv
//This version has been modified for use in BloxdModerationLog.

const config = {
  SERVER_LOGS_PER_MESSAGE: 5,
  BLOCK_LOGS_PER_MESSAGE: 3,
  PREVENT_CHANGE_BY_EXPLOSIVE: true,
  SAVE_CHANGE_BY_WORLD: false,
  SAVE_DATA_CHANGED_BY_WORLD: true,
  SAVE_DATA_CHANGED_BY_PLAYER: true,
  MAX_BLOCK_HISTORY: 5,
  INSPECT_SHOW_NEWEST_FIRST: true,
  ENABLE_LOGGING: true,
  SEARCH_TIMEOUT: 1000,
  ALLOW_LIST: ["5hFYzhrL29VWQHxYvaAHe"],
  BLACK_LIST: []
};

S={t:{},g:{},c:0,o:0,i:0,d:{get false(){let e=S.t[S.c];do{let t=3*S.i;[e[t],e=>e][+(e[t+2]<S.g[e[t+1]])]()}while(++S.i<e.length/3);delete S.t[S.c],S.i=0}},run(e,t,l){let o=S.c-~t-1,s=S.t[o]=[S.t[o],[]][+!S.t[o]],n=s.length;s[n]=e,s[n+1]=[l,"0"][+!l],s[n+2]=S.o++},stop(e){S.g[e]=S.o++}};const BASE=[-35e4,-35e4,-35e4],BASE2=[35e4,-35e4,35e4],MAX_X=7e5,MAX_Y=3e5,MAX_Z=7e5,ITEM="Stick",SLOTS=36,MAX_DESC=1976,MAX_RAM_CACHE_SIZE=2e3,MAX_CHEST_CACHE_SIZE=200,MAX_CHARS_PER_TICK=33.333333333333336;class LRUCache{constructor(e){this.maxSize=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}set(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxSize){let l=this.cache.keys().next().value;this.cache.delete(l)}this.cache.set(e,t)}}function safeMod(e,t){let l=0;for(let o=0;o<e.length;o++)l=(10*l+(e.charCodeAt(o)-48))%t;return l}function safeDivide(e,t){let l="",o=0;for(let s=0;s<e.length;s++){let n=10*o+(e.charCodeAt(s)-48);l+=n/t|0,o=n%t}return l.replace(/^0+/,"")}function makeStore(e){let t=new LRUCache(2e3),l=new LRUCache(200),o=(e,t,o,s,n,i)=>{api.setStandardChestItemSlot(e,t,o,s,n,i);let a=e+"",c=l.get(a);c||(c=api.getStandardChestItemSlots(e)),c[t]={name:o,amount:s,attributes:i},l.set(a,c)},s=(e,t)=>{let o=e+"",s=l.get(o);return s||(s=api.getStandardChestItems(e),l.set(o,s)),s[t]};return{RAMtasksQueue:{start:0,end:0},RAMcache:t,chestCache:l,setSlot:o,getSlot:s,decodeIndex(t){let l=String(t),o=safeMod(l,SLOTS);l=safeDivide(l,SLOTS);let s=safeMod(l,MAX_X);l=safeDivide(l,MAX_X);let n=safeMod(l,MAX_Y);l=safeDivide(l,MAX_Y);let i=safeMod(l,7e5);return{slot:o,pos:[e[0]+s,e[1]+n,e[2]+i]}}}}const S1=makeStore(BASE),S2=makeStore(BASE2);bim1={get(e,t){S1.RAMtasksQueue[S1.RAMtasksQueue.end++]=[0,e+"",t]},set(e,t,l){S1.RAMtasksQueue[S1.RAMtasksQueue.end++]=[1,e+"",l,t]}},bim2={get(e,t){S2.RAMtasksQueue[S2.RAMtasksQueue.end++]=[0,e+"",t]},set(e,t,l){S2.RAMtasksQueue[S2.RAMtasksQueue.end++]=[1,e+"",l,t]}};let RAMwait=0;tick=()=>{if(S.d[!S.t[S.c]],S.c++,RAMwait>33.333333333333336){RAMwait-=33.333333333333336;return}RAMwait=0;let e=3*api.getNumPlayers();function t(t){let l=t.RAMtasksQueue;main:for(let o=0;o<e;o++){if(l.start===l.end){l.start=l.end=0;break}let s=l[l.start],n=s[0],i=s[1],a=s[2],c=(s[3]??"")+"",r=t.decodeIndex(i),u=r.pos,h=r.slot;if(!api.isBlockInLoadedChunk(...u)){api.getBlock(u);break}if(n){let $=c.slice(0,1976);"Loot Chest"!==api.getBlock(u)&&(api.setBlock(u,"Loot Chest"),RAMwait+=210),t.setSlot(u,h,ITEM,1,void 0,{customDescription:$}),t.RAMcache.set(i,{val:$,max:$.length}),a&&a(i,$)}else{let d="",g=t.RAMcache.get(i);if(g)d=g.val;else if("Loot Chest"===api.getBlock(u)){let f=t.getSlot(u,h);f?.name===ITEM&&(d=f.attributes?.customDescription||"")}t.RAMcache.set(i,{val:d,max:d.length}),a&&a(i,d)}if(delete l[l.start++],RAMwait>33.333333333333336)break main}}t(S1),t(S2)};class log{constructor(){this.Queue=[],this.count=1,this.saving=!1,this.META_COUNT_KEY=0,this.maxLen=12,this.blockQueue=[],this.blockSaving=!1,this.blockCount=1,this.blockWriteKey=1,this.BLOCK_META_COUNT_KEY=0,this.blockMaxLen=10,this.BLOCK_ACTION={place:1,break:2,replace:3,worldChange:4};let e=this;this.ready=!1,this.bim1Get(this.META_COUNT_KEY,function(t){let l=Number(t);e.count=Number.isFinite(l)&&l>0?l:1,e.writeKey=e.count,e._timer=S.run(function t(){e.flushTemporary(),S.run(t,100,"timer")},1),e.ready=!0}),this.bim2Get(this.BLOCK_META_COUNT_KEY,t=>{let l=Number(t);this.blockCount=Number.isFinite(l)&&l>0?l:1,this.blockWriteKey=this.blockCount,e._blockTimer=S.run(function t(){e.flushBlockTemporary(),S.run(t,500,"blocktimer")},1)})}convertToDate(e){let t=Math.floor(e/1e3)+32400,l=Math.floor(t/86400),o=t%86400,s=1970,n=e=>e%4==0&&(e%100!=0||e%400==0);for(;;){let i=n(s)?366:365;if(l<i)break;l-=i,s++}let a=[31,n(s)?29:28,31,30,31,30,31,31,30,31,30,31],c=0;for(;l>=a[c];)l-=a[c],c++;return{year:s,month:c+1,date:l+1,hour:Math.floor(o/3600),minutes:Math.floor(o%3600/60),second:o%60}}zigzag=e=>e>=0?2*e:-(2*e)-1;unzigzag=e=>1&e?-(e+1)/2:e/2;encInt=e=>{let t=this.zigzag(e),l="";for(;t>=8192;)l+=String.fromCharCode(8191&t|8192),t=Math.floor(t/8192);return l+String.fromCharCode(t)};decInt=(e,t)=>{let l=0,o=0,s;do l+=(8191&(s=e.charCodeAt(t++)))*Math.pow(8192,o++);while(8192&s);return[this.unzigzag(l),t]};bim1Get(e,t){bim1.get(e,(e,l)=>t(l))}bim1Set(e,t,l){bim1.set(e,t,()=>l&&l())}addQueue(e){this.Queue.push(e),this.Queue.length>=this.maxLen&&this.flushTemporary()}addQueueImmediate(e){this.Queue.push(e),this.saving||this.flushTemporary()}_takeQueue(){let e=this.Queue;return this.Queue=[],e}flushTemporary(){if(this.saving||0===this.Queue.length)return;this.saving=!0;let e=this._takeQueue(),t=this.writeKey,l=this;this.bim1Get(t,function(o){let s;try{s=o?JSON.parse(o):[],Array.isArray(s)||(s=[])}catch{s=[]}let n=l.maxLen-s.length;n>0&&(s.push.apply(s,e.slice(0,n)),l.bim1Set(t,JSON.stringify(s)));let i=e.slice(n);i.length>0?l.bim1Set(l.META_COUNT_KEY,String(t+1),function(){l.count=t+1,l.writeKey=l.count,l.Queue.unshift.apply(l.Queue,i),l.saving=!1,l.Queue.length>0&&l.flushTemporary()}):(l.saving=!1,l.Queue.length>0&&l.flushTemporary())})}formatLog(e){let[t,l,o,s,n]=e.split("|"),i=this.convertToDate(Number(t)),a=e=>String(e).padStart(2,"0"),c=`${i.year}/${a(i.month)}/${a(i.date)} ${a(i.hour)}:${a(i.minutes)}:${a(i.second)}`;return[c,l,o,s,n||""]}bim2Get(e,t){bim2.get(e,(e,l)=>t(l))}bim2Set(e,t,l){bim2.set(e,t,()=>l&&l())}addBlockQueue(e){this.blockQueue.push(e),this.blockQueue.length>=this.blockMaxLen&&this.flushBlockTemporary()}addBlockQueueImmediate(e){this.blockQueue.push(e),this.blockSaving||this.flushBlockTemporary()}_takeBlockQueue(){let e=this.blockQueue;return this.blockQueue=[],e}flushBlockTemporary(){if(this.blockSaving||0===this.blockQueue.length)return;this.blockSaving=!0;let e=this._takeBlockQueue(),t=this.blockWriteKey,l=!1,o=()=>{!l&&(l=!0,this.blockSaving=!1,this.blockQueue.length>0&&this.flushBlockTemporary())};this.bim2Get(t,l=>{let s;try{s=l?JSON.parse(l):[],Array.isArray(s)||(s=[])}catch{s=[]}let n=this.blockMaxLen-s.length,i=n>0?e.slice(0,n):[],a=e.slice(i.length);i.length>0&&s.push(...i),this.bim2Set(t,JSON.stringify(s),()=>{let e=s.length>=this.blockMaxLen;if(a.length>0||e){let l=t+1;this.bim2Set(this.BLOCK_META_COUNT_KEY,String(l),()=>{this.blockCount=l,this.blockWriteKey=l,a.length>0&&this.blockQueue.unshift(...a),o()})}else o()})}),S.run(()=>{this.blockSaving&&(api.log("[log] blockSaving timeout -> force release"),o())},100,"blockFailSafe")}encodeBlockLog({epoch:e,x:t,y:l,z:o,action:s,block:n,dbId:i,name:a}){let c=e=>this.encInt(e.length)+e;return this.encInt(e)+this.encInt(t)+this.encInt(l)+this.encInt(o)+this.encInt(this.BLOCK_ACTION[s]||0)+c(i)+c(a)+c(n||"")}decodeBlockLog(e){let t=0,l;[l,t]=this.decInt(e,t);let o=l;[l,t]=this.decInt(e,t);let s=l;[l,t]=this.decInt(e,t);let n=l;[l,t]=this.decInt(e,t);let i=l;[l,t]=this.decInt(e,t);let a=l;[l,t]=this.decInt(e,t);let c=e.slice(t,t+l);t+=l,[l,t]=this.decInt(e,t);let r=e.slice(t,t+l);t+=l,[l,t]=this.decInt(e,t);let u=e.slice(t,t+l);return t+=l,{epoch:o,x:s,y:n,z:i,action:a,dbId:c,name:r,block:u}}}const logInstance=new log,inspector=new Set,BanQueue=new Set;function makeLogStr(e,t,l=""){let o=api.now(),s;return`${o}|${t}|${api.getEntityName(e)}|${api.getPlayerDbId(e)}|${l}`}function onReady(e){logInstance.ready?e():S.run(()=>onReady(e),200)}S.run(function e(){[...BanQueue].forEach(e=>{api.getPlayerIds().includes(e)&&api.kickPlayer(e,"Banned from lobby")}),S.run(e,20)}),onPlayerJoin=e=>{let t=makeLogStr(e,"join"),l=api.getPlayerDbId(e);config.BLACK_LIST.includes(l)&&BanQueue.add(e),onReady(()=>{config.ENABLE_LOGGING&&logInstance.addQueueImmediate(t)})},onPlayerLeave=e=>{BanQueue.has(e)&&BanQueue.delete(e)},onPlayerChat=(e,t)=>{let l=makeLogStr(e,"chat",t);onReady(()=>{config.ENABLE_LOGGING&&logInstance.addQueue(l)})},onPlayerChangeBlock=(e,t,l,o,s,n)=>{if(!logInstance.ready)return;if(inspector.has(e)){let i=api.getBlockData(t,l,o),a=i?.persisted??{},c=Array.isArray(a.log)?a.log.slice():[];if(0===c.length)return api.sendMessage(e,[{str:"このブロックには履歴がありません\n",style:{color:"#999999"}}]),"preventChange";let r=e=>String(e).padStart(2,"0"),u=config.INSPECT_SHOW_NEWEST_FIRST?c.slice().reverse():c,h=u.flatMap(({epoch:e,action:t,from:l,to:o,dbId:s,name:n})=>{let i=logInstance.convertToDate(e),a="Air"===o?l:o,c=`${i.year}/${r(i.month)}/${r(i.date)} ${r(i.hour)}:${r(i.minutes)}:${r(i.second)}`;return[{str:`[${c}] `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:`${n} `,style:{color:"#0090a8",fontStyle:"italic"}},{str:`${t} `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:`${a}`,style:{color:"#0090a8",fontStyle:"italic"}},{str:` (${s})
`,style:{color:"#D3D3D3",fontStyle:"italic"}}]});return api.sendMessage(e,h),"preventChange"}let $,d;"Air"===s&&"Air"!==n?($="place",d=n):"Air"!==s&&"Air"===n?($="break",d=s):($="replace",d=n);let g=api.getPlayerDbId(e),f=api.getEntityName(e)||"unknown",y=logInstance.encodeBlockLog({epoch:api.now(),x:0|t,y:0|l,z:0|o,action:$,block:d,dbId:g,name:f});if(logInstance.addBlockQueue(y),config.SAVE_DATA_CHANGED_BY_PLAYER){let k=api.getBlockData(t,l,o),m=k?.persisted??{},A=Array.isArray(m.log)?m.log.slice():[];A.push({epoch:api.now(),action:$,from:s,to:n,dbId:g,name:f}),A.length>config.MAX_BLOCK_HISTORY&&(A=A.slice(-1*config.MAX_BLOCK_HISTORY)),api.setBlockData(t,l,o,{persisted:{log:A}})}},onWorldChangeBlock=(e,t,l,o,s,n,i)=>{let a=api.getEntityName(api.getPlayerIdFromDbId(n));if(config.SAVE_CHANGE_BY_WORLD){let c=logInstance.encodeBlockLog({epoch:api.now(),x:0|e,y:0|t,z:0|l,action:"worldChange",block:`${o||"unknown"}->${s||"unknown"}`,dbId:n||"unknown",name:a||"unknown"});logInstance.addBlockQueue(c)}if(config.SAVE_CHANGE_BY_WORLD){let r=api.getBlockData(e,t,l),u=r?.persisted??{},h=Array.isArray(u.log)?u.log.slice():[];h.push({epoch:api.now(),action:"worldChange",from:o,to:s,dbId:n,name:a||"unknown"}),h.length>5&&(h=h.slice(h.length-5)),api.setBlockData(e,t,l,{persisted:{log:h}})}if(i?.cause==="Explosion"&&config.PREVENT_CHANGE_BY_EXPLOSIVE)return"preventChange"},playerCommand=(e,t)=>{let l=t.split(" "),o=l[0],s=api.getPlayerDbId(e),n=config.ALLOW_LIST.includes(s);if(n||api.sendMessage(e,"許可リストに含まれていないためコマンドは使用できません"),"bml"===o&&("inspect"===l[1]||"i"===l[1])&&n)return inspector.has(e)?(inspector.delete(e),api.sendMessage(e,"BloxdModeratorLog: inspecter now disable!"),!0):(inspector.add(e),api.sendMessage(e,"BloxdModeratorLog: inspecter now enable!"),!0);if("bml"===o&&"log"===l[1]&&n){let i=l[2],a=l[3],c=l[4],r=l[5],u=l[6];return onReady(()=>{let t=Date.now();api.sendMessage(e,[{str:"Searching logs...\n",style:{color:"#aaaaaa",fontStyle:"italic"}}]);let l=config.SERVER_LOGS_PER_MESSAGE,o="*"===i,s=o?0:parseInt(i),n=o?0:s*l,h=0,$=[],d=0,g=e=>"join"===e?"#5AFF19":"leave"===e?"#B1221A":"#FFC800";function f(t){if(t.length>0)try{api.sendMessage(e,t)}catch(l){api.log(l.message,l.stack)}}function y(){if(Date.now()-t>config.SEARCH_TIMEOUT){k();return}logInstance.bim1Get(d,e=>{if(null==e){k();return}let s;try{s=JSON.parse(e),Array.isArray(s)||(s=[])}catch{s=[]}for(let i of s){let g=logInstance.formatLog(i),[f,m,A,_,b]=g,p=!0;if(a&&"*"!==a&&A!==a&&_!==a&&(p=!1),c&&"*"!==c&&m!==c&&(p=!1),!u||"*"===u||b&&b.includes(u)||(p=!1),r&&"*"!==r){let[I,M]=r.split(":"),C=10===M.length?M+" 00:00:00":M;if("after"===I&&f<C||"before"===I&&f>C)continue}if(p&&(h>=n&&$.length<l&&$.push(g),h++,!o&&$.length>=l||Date.now()-t>config.SEARCH_TIMEOUT)){k();return}}d++,y()})}function k(){let e=[{str:`=== Core Protect ${o?"(first "+l+")":`(page ${s})`} ===
`,style:{color:"#aaaaaa",fontStyle:"italic"}}];if(0===$.length){e.push({str:"No logs matched your query.\n",style:{color:"#888888",fontStyle:"italic"}}),f(e);return}for(let t of $){let[n,i,a,c,r]=t;r?e.push({str:`[${n}] `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:`[${i}] `,style:{color:g(i),fontStyle:"italic"}},{str:a+" ",style:{color:"#0090a8",fontStyle:"italic"}},{str:r,style:{fontStyle:"italic"}},{str:` (${c})
`,style:{color:"#D3D3D3",fontStyle:"italic"}}):e.push({str:`[${n}] `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:a+" ",style:{color:"#0090a8",fontStyle:"italic"}},{str:`${i}ed`,style:{color:g(i),fontStyle:"italic"}},{str:` (${c})
`,style:{color:"#D3D3D3",fontStyle:"italic"}})}f(e)}y()}),!0}if("bml"===o&&"block"===l[1]&&n){let h=e=>e&&"*"!==e?["+","place","set"].includes(e=e.toLowerCase())?"+":["-","break","remove"].includes(e)?"-":["⟳","update","change"].includes(e)?"⟳":["✧","custom"].includes(e)?"✧":e:"*",$=l[2]||1,d=l[3],g=l[4],f=h(g),y=l[5],k=l[6],m=t.match(/"([^"]+)"/);m&&(k=m[1]);let A=e=>1===e?"+":2===e?"-":3===e?"⟳":4===e?"✧":"unknown",_=e=>"+"===e?"#5AFF19":"-"===e?"#B1221A":"✧"===e?"#007DC5":"#FFC800";function b(t){if(t.length>0)try{api.sendMessage(e,t)}catch(l){api.log(l.message),api.log(l.stack)}}return onReady(()=>{let t=Date.now(),l=config.BLOCK_LOGS_PER_MESSAGE,o="*"===$,s=o?0:parseInt($),n=o?0:s*l,i=o?1/0:n+l,a=0,c=[],r=0;function u(){if(Date.now()-t>=config.SEARCH_TIMEOUT){h();return}api.getPosition(e),logInstance.bim2Get(r,e=>{if(null!=e){let s;try{s=JSON.parse(e),Array.isArray(s)||(s=[])}catch{s=[]}for(let $ of s){let g=logInstance.decodeBlockLog($),m=logInstance.convertToDate(g.epoch),_=e=>String(e).padStart(2,"0"),b=`${m.year}/${_(m.month)}/${_(m.date)} ${_(m.hour)}:${_(m.minutes)}:${_(m.second)}`,p=A(g.action);if((!d||"*"===d||g.name===d||g.dbId===d)&&(!f||"*"===f||p===f)&&(!k||"*"===k||g.block&&g.block.includes(k))){if(y&&"*"!==y){let[I,M]=y.split(":"),C=10===M.length?M+" 00:00:00":M;if("after"===I&&b<C||"before"===I&&b>C)continue}if(a>=n&&c.length<l&&c.push({time:b,name:g.name,dbId:g.dbId,x:g.x,y:g.y,z:g.z,action:p,block:g.block||""}),a++,!o&&a>=i)break}}}if(r++,Date.now()-t>=config.SEARCH_TIMEOUT){h();return}c.length<l&&(!o||a<i)?u():h()})}function h(){let e=[{str:`=== Block Log ${o?"(first "+l+")":`(page ${s})`} ===
`,style:{color:"#aaaaaa",fontStyle:"italic"}}];for(let t of c)e.push({str:`[${t.time}] `,style:{color:"#D3D3D3",fontStyle:"italic"}},{str:t.name+" ",style:{color:"#0090a8",fontStyle:"italic"}},{str:t.action+" ",style:{color:_(t.action),fontStyle:"italic",fontSize:"20px"}},{str:t.block+" ",style:{color:"#FFC800",fontStyle:"italic"}},{str:`at (${t.x},${t.y},${t.z})`,style:{fontStyle:"italic"}},{str:` (${t.dbId})
`,style:{color:"#D3D3D3",fontStyle:"italic"}});b(e)}u()}),!0}};
